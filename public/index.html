<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mo聊天室</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --left-bg: #fff;
            --left-border: #ddd;
            --chat-bg: #fff;
            --input-bg: #fff;
            --input-border: #ccc;
            --message-right-color: #007bff;
            --button-bg: #007bff;
            --button-hover-bg: #0056b3;
        }

        .dark-mode {
            --bg-color: #1e1e1e;
            --left-bg: #2c2c2c;
            --left-border: #444;
            --chat-bg: #1e1e1e;
            --input-bg: #2c2c2c;
            --input-border: #555;
            --message-right-color: #007bff;
            --button-bg: #555;
            --button-hover-bg: #777;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; width: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: var(--bg-color); }
        body { display: flex; }

        /* 左侧栏 */
        #left { 
            width: 250px; 
            background: var(--left-bg); 
            padding: 20px; 
            border-right: 1px solid var(--left-border); 
            overflow-y: auto; 
            transition: width 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #left.hidden { 
            width: 40px; 
            padding: 0; 
            overflow: hidden; 
        }
        #left.hidden #toggle-users { 
            width: 40px; 
            padding: 10px 5px; 
            border-radius: 0; 
        }
        #left.hidden #userList,
        #left.hidden #username,
        #left.hidden #join-btn,
        #left.hidden #dark-mode-toggle,
        #left.hidden h3 { 
            display: none; 
        }

        button {
            background: var(--button-bg);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
        }
        button:hover {
            background: var(--button-hover-bg);
        }
        #join-btn { background: #28a745; }
        #join-btn:hover { background: #218838; }

        /* 右侧聊天区 */
        #right { flex: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #chat { flex: 1; padding: 15px; background: var(--chat-bg); overflow-y: auto; display: flex; flex-direction: column; }

        /* 普通文本消息 */
        .message-left, .message-right {
            margin: 6px 0;
            font-size: 16px;
            background: none;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            word-break: break-word;
        }
        .message-left { align-self: flex-start; }
        .message-right { align-self: flex-end; color: var(--message-right-color); }

        .message-username {
            font-weight: bold;
            margin-bottom: 2px;
            font-size: 14px;
        }
        .timestamp {
            font-size: 12px;
            color: #888;
            margin-top: 2px;
        }

        /* 系统提示消息 */
        .message-system {
            text-align: center;
            font-size: 14px;
            color: #666;
            font-style: italic;
            margin: 10px 0;
        }

        /* 输入区域 */
        #input-area { padding: 10px; background: var(--input-bg); display: flex; align-items: center; border-top: 1px solid var(--left-border); }
        #message { flex: 1; padding: 12px; border: 1px solid var(--input-border); border-radius: 8px; margin-right: 10px; font-size: 16px; background: var(--input-bg); color: inherit; }
        #send-btn { padding: 12px 20px; font-size: 16px; }

        #left h3 { margin-bottom: 10px; font-size: 20px; }
        #userList li { list-style: none; padding: 6px 0; font-size: 16px; }
        #username { width: 100%; padding: 12px; border: 1px solid var(--input-border); border-radius: 8px; font-size: 16px; background: var(--input-bg); color: inherit; }
    </style>
</head>
<body>
    <div id="left">
        <h3>当前在线用户</h3>
        <ul id="userList"></ul>
        <input type="text" id="username" placeholder="输入用户名">
        <button id="join-btn" disabled>加入聊天</button>
        <button id="dark-mode-toggle">切换模式</button>
        <button id="toggle-users">隐藏用户</button>
    </div>

    <div id="right">
        <div id="chat"></div>
        <div id="input-area">
            <input type="text" id="message" placeholder="输入消息">
            <button id="send-btn">发送</button>
        </div>
    </div>

    <script>
        const roomId = location.pathname.split('/')[1] || 'default';
        let ws, username, joined = false, gotInitialList = false, currentUsers = [];

        function connectWebSocket() {
            const proto = location.protocol === 'https:' ? 'wss' : 'ws';
            ws = new WebSocket(`${proto}://${location.host}/${roomId}`);

            ws.onopen = () => console.log('WebSocket 已连接');

            ws.onmessage = ({ data }) => {
                let msg;
                try { msg = JSON.parse(data); }
                catch { return; }

                switch (msg.type) {
                    case 'userList':
                        updateUserList(msg.users);
                        if (!gotInitialList) {
                            gotInitialList = true;
                            document.getElementById('join-btn').disabled = false;
                        }
                        break;
                    case 'message':
                        addMessage(msg.username, msg.message);
                        break;
                    case 'joinError':
                        alert('用户名已存在，请重新输入');
                        joined = false;
                        break;
                }
            };

            ws.onclose = () => {
                console.log('WebSocket 断开');
                clearChat();
                updateUserList([]);
                joined = false;
                gotInitialList = false;
                addSystemMessage('连接已断开，聊天记录已清空');
            };

            ws.onerror = err => console.error('WebSocket 错误:', err);
        }

        connectWebSocket();

        function joinChat() {
            if (!gotInitialList) return alert('正在获取用户列表，请稍后');
            if (joined) return alert('您已加入聊天室');
            username = document.getElementById('username').value.trim();
            if (!username) return alert('请输入用户名');
            if (currentUsers.includes(username)) return alert('用户名已存在，请换一个');
            ws.send(JSON.stringify({ type: 'join', username }));
            joined = true;
        }

        function sendMessage() {
            const text = document.getElementById('message').value.trim();
            if (!joined) return alert('请先加入聊天室');
            if (!text) return;
            ws.send(JSON.stringify({ type: 'message', message: text }));
            document.getElementById('message').value = '';
        }

        function addMessage(sender, text) {
            const chat = document.getElementById('chat');
            const div = document.createElement('div');
            div.className = sender === username ? 'message-right' : 'message-left';
            div.innerHTML = `
                <div class="message-username">${sender}</div>
                <div>${text}</div>
                <div class="timestamp">${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
            `;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function addSystemMessage(text) {
            const chat = document.getElementById('chat');
            const div = document.createElement('div');
            div.className = 'message-system';
            div.textContent = `系统提示：${text}`;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function updateUserList(users) {
            currentUsers = users;
            const ul = document.getElementById('userList');
            ul.innerHTML = '';
            users.forEach(u => {
                const li = document.createElement('li');
                li.textContent = u;
                ul.appendChild(li);
            });
        }

        function clearChat() {
            document.getElementById('chat').innerHTML = '';
        }

        document.getElementById('join-btn').addEventListener('click', joinChat);
        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('message').addEventListener('keypress', e => {
            if (e.key === 'Enter') { e.preventDefault(); sendMessage(); }
        });

        // 每10分钟自动清屏并提示
        setInterval(() => {
            clearChat();
            addSystemMessage('聊天记录已清空');
        }, 600000);
    </script>
</body>
</html>

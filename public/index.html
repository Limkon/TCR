<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>高级版聊天室</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { height: 100%; width: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #f0f2f5; }
body { display: flex; }
#left { 
    width: 250px; 
    background: #fff; 
    padding: 20px; 
    border-right: 1px solid #ddd; 
    overflow-y: auto; 
    position: relative;
    transition: transform 0.3s ease;
}
#left.hidden { 
    transform: translateX(-100%); 
}
#toggle-users { 
    position: absolute; 
    top: 20px; 
    left: 100%; 
    transform: rotate(-90deg) translateX(-50%); 
    transform-origin: left top; 
    background: #007bff; 
    color: white; 
    border: none; 
    border-radius: 8px; 
    padding: 8px 12px; 
    cursor: pointer; 
    font-size: 14px; 
    z-index: 1000;
}
#toggle-users:hover { background: #0056b3; }
#right { flex: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
#chat { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; }
.message-left, .message-right {
    max-width: 70%;
    padding: 10px 14px;
    margin: 6px 0;
    border-radius: 18px;
    font-size: 16px;
    position: relative;
    word-break: break-word;
}
.message-left {
    background: #e9ecef;
    align-self: flex-start;
}
.message-right {
    background: #007bff;
    color: white;
    align-self: flex-end;
}
.timestamp {
    font-size: 12px;
    color: #888;
    margin-top: 2px;
    text-align: center;
}
#input-area { padding: 10px; background: #fff; display: flex; align-items: center; border-top: 1px solid #ddd; }
#message { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 8px; margin-right: 10px; font-size: 16px; }
#send-btn { padding: 12px 20px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }
#send-btn:hover { background: #0056b3; }
#left h3 { margin-bottom: 20px; font-size: 20px; }
#userList li { list-style: none; padding: 10px 0; font-size: 18px; }
#username { width: 100%; padding: 12px; margin: 20px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 18px; }
#join-btn { width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; }
#join-btn:hover { background: #218838; }

/* 移动端适配 */
@media (max-width: 768px) {
    body { flex-direction: column; }
    #left { 
        width: 100%; 
        height: 100vh; 
        position: fixed; 
        top: 0; 
        left: 0; 
        transform: translateX(-100%); 
        z-index: 1000; 
        background: #fff; 
        box-shadow: 2px 0 5px rgba(0,0,0,0.2); 
    }
    #left.hidden { 
        transform: translateX(-100%); 
    }
    #toggle-users {
        top: 20px;
        left: 10px;
        transform: none;
        position: fixed;
    }
    #right { height: calc(100vh - 70px); }
    #chat { padding: 10px; }
    #input-area { height: 70px; background: #fff; padding: 8px; }
    #message { font-size: 14px; padding: 10px; border-radius: 20px; }
    #send-btn { padding: 10px 15px; font-size: 14px; border-radius: 20px; }
    #username { font-size: 16px; padding: 12px; }
    #join-btn { font-size: 16px; padding: 12px; }
}
</style>
</head>
<body>
<div id="left" class="hidden">
    <button id="toggle-users" onclick="toggleUserList()">显示用户</button>
    <h3>在线用户</h3>
    <ul id="userList"></ul>
    <input type="text" id="username" placeholder="输入用户名">
    <button id="join-btn" onclick="joinChat()">加入</button>
</div>
<div id="right">
    <div id="chat"></div>
    <div id="input-area">
        <input type="text" id="message" placeholder="输入消息">
        <button id="send-btn" onclick="sendMessage()">发送</button>
    </div>
</div>

<script>
const roomId = location.pathname.split('/')[1] || 'default';
let ws;
let username;
let joined = false;

function connectWebSocket(protocol) {
    const host = location.hostname;
    const port = location.port || (location.protocol === 'https:' ? '443' : '80');
    const wsUrl = `${protocol}://${host}:${port}/${roomId}`;
    ws = new WebSocket(wsUrl);

    ws.onopen = () => {
        console.log('WebSocket 已连接');
    };

    ws.onerror = (error) => {
        console.error('WebSocket 错误:', error);
        alert('无法连接到聊天服务器，请检查网络或稍后重试');
    };

    ws.onclose = () => {
        console.log('WebSocket 已关闭');
        document.getElementById('chat').innerHTML = '';
    };

    ws.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            if (data.type === 'userList') {
                const userList = document.getElementById('userList');
                userList.innerHTML = '';
                data.users.forEach(user => {
                    const li = document.createElement('li');
                    li.textContent = user;
                    userList.appendChild(li);
                });
            } else if (data.type === 'message') {
                addMessage(data.username, data.message);
            } else if (data.type === 'clearChat') {
                document.getElementById('chat').innerHTML = '';
            } else if (data.type === 'error') {
                alert(data.message);
            }
        } catch (error) {
            console.error('消息解析错误:', error);
        }
    };
}

connectWebSocket(location.protocol === 'https:' ? 'wss' : 'ws');

function toggleUserList() {
    const leftPanel = document.getElementById('left');
    const toggleButton = document.getElementById('toggle-users');
    leftPanel.classList.toggle('hidden');
    toggleButton.textContent = leftPanel.classList.contains('hidden') ? '显示用户' : '隐藏用户';
}

function joinChat() {
    if (joined) {
        alert('您已经加入过了');
        return;
    }
    username = document.getElementById('username').value.trim();
    if (username && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'join', username }));
        joined = true;
    } else {
        alert('请输入用户名或等待服务器连接');
    }
}

function sendMessage() {
    const message = document.getElementById('message').value.trim();
    if (message && username && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'message', message }));
        addMessage(username, message, true);
        document.getElementById('message').value = '';
    } else {
        alert('请先加入聊天室、输入消息或等待服务器连接');
    }
}

function addMessage(sender, text, isSelf = false) {
    const chat = document.getElementById('chat');
    const messageDiv = document.createElement('div');
    messageDiv.className = isSelf || sender === username ? 'message-right' : 'message-left';
    messageDiv.innerHTML = `<div>${text}</div><div class="timestamp">${getCurrentTime()}</div>`;
    chat.appendChild(messageDiv);
    chat.scrollTop = chat.scrollHeight;
}

function getCurrentTime() {
    const now = new Date();
    return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

document.getElementById('message').addEventListener('keypress', (event) => {
    if (event.key === 'Enter') {
        event.preventDefault();
        sendMessage();
    }
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mo聊天室</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --left-bg: #fff;
            --left-border: #ddd;
            --chat-bg: #fff;
            --input-bg: #fff;
            --input-border: #ccc;
            --message-left-bg: #e9ecef; /* 亮色模式 */
            --message-right-bg: #007bff;
            --message-right-color: white;
            --button-bg: #007bff;
            --button-hover-bg: #0056b3;
        }

        .dark-mode {
            --bg-color: #1e1e1e;
            --left-bg: #2c2c2c;
            --left-border: #444;
            --chat-bg: #1e1e1e;
            --input-bg: #2c2c2c;
            --input-border: #555;
            --message-left-bg: #ffffff; /* 暗色模式 */
            --message-right-bg: #007bff;
            --message-right-color: white;
            --button-bg: #555;
            --button-hover-bg: #777;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; width: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: var(--bg-color); }
        body { display: flex; }

        #left { 
            width: 250px; 
            background: var(--left-bg); 
            padding: 20px; 
            border-right: 1px solid var(--left-border); 
            overflow-y: auto; 
            transition: width 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #left.hidden { 
            width: 40px; 
            padding: 0; 
            overflow: hidden; 
        }
        #left.hidden #toggle-users { 
            width: 40px; 
            padding: 10px 5px; 
            border-radius: 0; 
        }
        #left.hidden #userList, 
        #left.hidden #username, 
        #left.hidden #join-btn, 
        #left.hidden #dark-mode-toggle, 
        #left.hidden h3 { 
            display: none; 
        }

        #toggle-users, 
        #dark-mode-toggle, 
        #join-btn {
            background: var(--button-bg);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
        }
        #toggle-users:hover, 
        #dark-mode-toggle:hover, 
        #join-btn:hover { 
            background: var(--button-hover-bg); 
        }
        #join-btn { background: #28a745; }
        #join-btn:hover { background: #218838; }

        #right { flex: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #chat { flex: 1; padding: 15px; background: var(--chat-bg); overflow-y: auto; display: flex; flex-direction: column; }
        .message-left, .message-right {
            max-width: 70%;
            padding: 10px 14px;
            margin: 6px 0;
            border-radius: 18px;
            font-size: 16px;
            word-break: break-word;
            background: var(--message-left-bg);
        }
        .message-left { align-self: flex-start; }
        .message-right { 
            align-self: flex-end; 
            background: var(--message-right-bg); 
            color: var(--message-right-color);
        }
        .message-username { font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        .timestamp { font-size: 12px; color: #888; margin-top: 2px; text-align: center; }
        #input-area { padding: 10px; background: var(--input-bg); display: flex; align-items: center; border-top: 1px solid var(--left-border); }
        #message { flex: 1; padding: 12px; border: 1px solid var(--input-border); border-radius: 8px; margin-right: 10px; font-size: 16px; background: var(--input-bg); color: inherit; }
        #send-btn { padding: 12px 20px; background: var(--button-bg); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }
        #send-btn:hover { background: var(--button-hover-bg); }
        #left h3 { margin-bottom: 10px; font-size: 20px; }
        #userList li { list-style: none; padding: 10px 0; font-size: 18px; }
        #username { width: 100%; padding: 12px; border: 1px solid var(--input-border); border-radius: 8px; font-size: 18px; background: var(--input-bg); color: inherit; }
    </style>
</head>

<body>
    <div id="left">
        <h3>在线用户</h3>
        <ul id="userList"></ul>
        <input type="text" id="username" placeholder="输入用户名">
        <button id="join-btn">加入</button>
        <button id="dark-mode-toggle">切换模式</button>
        <button id="toggle-users">隐藏用户</button>
    </div>

    <div id="right">
        <div id="chat"></div>
        <div id="input-area">
            <input type="text" id="message" placeholder="输入消息">
            <button id="send-btn">发送</button>
        </div>
    </div>

    <script>
        const roomId = location.pathname.split('/')[1] || 'default';
        let ws;
        let username;
        let joined = false;

        function connectWebSocket(protocol) {
            const host = location.hostname;
            const port = location.port || (location.protocol === 'https:' ? '443' : '80');
            const wsUrl = `${protocol}://${host}:${port}/${roomId}`;
            ws = new WebSocket(wsUrl);

            ws.onopen = () => console.log('WebSocket 已连接');
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'userList') {
                        const userList = document.getElementById('userList');
                        userList.innerHTML = '';
                        data.users.forEach(user => {
                            const li = document.createElement('li');
                            li.textContent = user;
                            userList.appendChild(li);
                        });
                    } else if (data.type === 'message') {
                        addMessage(data.username, data.message);
                    }
                } catch (error) {
                    console.error('消息解析错误:', error);
                }
            };
        }

        connectWebSocket(location.protocol === 'https:' ? 'wss' : 'ws');

        function toggleUserList() {
            const leftPanel = document.getElementById('left');
            const toggleButton = document.getElementById('toggle-users');
            leftPanel.classList.toggle('hidden');
            toggleButton.textContent = leftPanel.classList.contains('hidden') ? '显示用户' : '隐藏用户';
        }

        function joinChat() {
            if (joined) {
                alert('您已经加入过了');
                return;
            }
            username = document.getElementById('username').value.trim();
            if (username && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'join', username }));
                joined = true;
            } else {
                alert('请输入用户名或等待服务器连接');
            }
        }

        function sendMessage() {
            const message = document.getElementById('message').value.trim();
            if (message && username && ws.readyState ===WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'message', message }));
                addMessage(username, message, true);
                document.getElementById('message').value = '';
            } else {
                alert('请先加入聊天室、输入消息或等待服务器连接');
            }
        }

        function addMessage(sender, text, isSelf = false) {
            const chat = document.getElementById('chat');
            const messageDiv = document.createElement('div');
            messageDiv.className = isSelf || sender === username ? 'message-right' : 'message-left';
            messageDiv.innerHTML = `
                <div class="message-username">${sender}</div>
                <div>${text}</div>
                <div class="timestamp">${getCurrentTime()}</div>
            `;
            chat.appendChild(messageDiv);
            chat.scrollTop = chat.scrollHeight;
        }

        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
        }

        // 事件绑定
        document.getElementById('toggle-users').addEventListener('click', toggleUserList);
        document.getElementById('join-btn').addEventListener('click', joinChat);
        document.getElementById('dark-mode-toggle').addEventListener('click', toggleDarkMode);
        document.getElementById('send-btn').addEventListener('click', () => sendMessage());
        document.getElementById('message').addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // 防止重复触发
                sendMessage();
            }
        });
    </script>
</body>
</html>
